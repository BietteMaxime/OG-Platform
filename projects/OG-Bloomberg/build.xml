<project name="og-bloomberg" default="compile">
	<property file="build.properties"/>
	
	<import file="${common.dir}/common.xml"/>
		
	<property file="config/server.properties"/>
	
	<available property="dbscript.create" value="${basedir}/create" file="${basedir}/create-db-common.sql" />
    <target name="dbscript-create-db-sql" if="dbscript.create">
            <subant target="create-db-sql-impl-2">
                    <property name="dbscript.prefix" value="create" />
                    <fileset file="${parent.dir}/build.xml" />
            </subant>
    </target>
    <available property="dbscript.upgrade" value="${basedir}/upgrade" file="${basedir}/upgrade-db-common.sql" />
    <target name="dbscript-upgrade-db-sql" if="dbscript.upgrade">
            <subant target="create-db-sql-impl-2">
                    <property name="dbscript.prefix" value="upgrade" />
                    <fileset file="${parent.dir}/build.xml" />
            </subant>
    </target>
    <target name="create-db-sql-impl" depends="dbscript-create-db-sql,dbscript-upgrade-db-sql" />
    <target name="create-db-sql-impl-2" if="dbscript.prefix">
            <echo>Writing ${basedir}/${dbscript.prefix}-db.sql</echo>
            <concat fixlastline="yes" force="no" destfile="${basedir}/${dbscript.prefix}-db.sql">
                    <header filtering="no" trimleading="true">-- IMPORTANT:
                    --
                    -- This file was generated by concatenating the other .sql files together. It can be
                    -- used for testing, but the separate SQL sequences will be necessary if the components
                    -- need to be installed in different databases.
                    --
                    -- Please do not modify it - modify the originals and recreate this using 'ant create-db-sql'.

                    </header>
                    <fileset file="${basedir}/${dbscript.prefix}-db-position.sql" />
            		<fileset file="${basedir}/${dbscript.prefix}-db-security.sql" />
                    <fileset file="${basedir}/${dbscript.prefix}-db-timeseries.sql" />
            </concat>
    </target>
    <target name="create-db-sql" description="--> create a single .sql files from the component ones">
            <subant target="create-db-sql-impl" genericantfile="${basedir}/build.xml">
                    <property name="parent.dir" value="${basedir}" />
                    <property name="common.dir" value="${common.dir}" />
                    <dirset dir="${install.dir}/db" includes="*/patch_*" />
            </subant>
    </target>

	<target name="create-server-db">
		<taskdef name="dbtool" classname="com.opengamma.util.test.DbTool" classpathref="lib.path.id" />
		<dbtool 
			jdbcUrl="${jdbc.url}"
			user="${jdbc.username}"
			password="${jdbc.password}"
			create="true"
			createTables="true"
			basedir="../OG-Security"
		 	/>
	</target>
	
	<target name="drop-server-db">
		<taskdef name="dbtool" classname="com.opengamma.util.test.DbTool" classpathref="lib.path.id" />
		<dbtool 
			jdbcUrl="${jdbc.url}"
			user="${jdbc.username}"
			password="${jdbc.password}"
			drop="true"
		 	/>
	</target>
	
	
	<path id="server.run.path.id">
		<path refid="run.path.id" />
		<path location="${basedir}/config" />
	</path>
	
	<target name="start-server">
		<java classname="com.opengamma.bbg.livedata.BloombergLiveDataServer" classpathref="server.run.path.id" failonerror="true" fork="true">
		</java>				
	</target>
	
</project>
