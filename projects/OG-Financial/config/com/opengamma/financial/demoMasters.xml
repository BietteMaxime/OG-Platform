<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE beans PUBLIC "-//SPRING//DTD BEAN//EN" "http://www.springframework.org/dtd/spring-beans.dtd">
<beans>

  <!-- Property file configuration -->
  <bean id="demoMastersProperties" class="org.springframework.beans.factory.config.PropertyPlaceholderConfigurer">
    <property name="ignoreUnresolvablePlaceholders" value="true" />
    <property name="location">
      <value>classpath:demoMasters-${opengamma.platform.runmode}.properties</value>
    </property>
  </bean>
  
  <!-- Active MQ -->
  <bean id="activeMQConnectionFactory" class="org.apache.activemq.ActiveMQConnectionFactory">
    <constructor-arg value="${activeMQ.brokerURL}" />
    <property name="WatchTopicAdvisories" value="false" /> <!-- IGN-94 -->
  </bean>
  <bean id="jmsConnectionFactory" class="org.apache.activemq.pool.PooledConnectionFactory" destroy-method="stop"> 
    <constructor-arg ref="activeMQConnectionFactory"/>
  </bean>
  <bean id="jmsConnector" class="com.opengamma.util.jms.JmsConnectorFactoryBean"> 
    <property name="name" value="Masters"/>
    <property name="connectionFactory" ref="jmsConnectionFactory"/>
  </bean>

  <import resource="classpath:com/opengamma/financial/common.xml" />

  <bean id="abstractDbConnector" class="com.opengamma.util.db.DbConnectorFactoryBean" abstract="true">
    <property name="transactionIsolationLevelName" value="ISOLATION_READ_COMMITTED" />
    <property name="transactionPropagationBehaviorName" value="PROPAGATION_REQUIRED" />
    <property name="hibernateMappingFiles">
      <list>
        <bean class="com.opengamma.masterdb.security.hibernate.HibernateSecurityMasterFiles"/>
      </list>
    </property>
  </bean>

  <bean id="cfgDataSource" class="org.apache.commons.dbcp.BasicDataSource" destroy-method="close">
    <property name="driverClassName" value="${opengamma.config.jdbc.driver}" />
    <property name="url" value="${opengamma.config.jdbc.url}" />
    <property name="username" value="${opengamma.config.jdbc.username}" />
    <property name="password" value="${opengamma.config.jdbc.password}" />
  </bean>

  <bean id="cfgDbConnector" parent="abstractDbConnector">
    <property name="name" value="Config"/>
    <property name="dataSource" ref="cfgDataSource"/>
    <property name="dialectName" value="${opengamma.config.db.dbdialect}"/>
  </bean>
  
  <bean id="finDataSource" class="org.apache.commons.dbcp.BasicDataSource" destroy-method="close">
    <property name="driverClassName" value="${opengamma.financial.jdbc.driver}" />
    <property name="url" value="${opengamma.financial.jdbc.url}" />
    <property name="username" value="${opengamma.financial.jdbc.username}" />
    <property name="password" value="${opengamma.financial.jdbc.password}" />
  </bean>

  <bean id="finDbConnector" parent="abstractDbConnector">
    <property name="name" value="Integration"/>
    <property name="dataSource" ref="finDataSource"/>
    <property name="dialectName" value="${opengamma.financial.db.dbdialect}"/>
  </bean>
  
  <bean id="htsDataSource" class="org.apache.commons.dbcp.BasicDataSource" destroy-method="close">
    <property name="driverClassName" value="${opengamma.hts.jdbc.driver}" />
    <property name="url" value="${opengamma.hts.jdbc.url}" />
    <property name="username" value="${opengamma.hts.jdbc.username}" />
    <property name="password" value="${opengamma.hts.jdbc.password}" />
  </bean>
  
  <bean id="htsDbConnector" class="com.opengamma.util.db.DbConnectorFactoryBean">
    <property name="name" value="TimeSeries"/>
    <property name="dataSource" ref="htsDataSource"/>
    <property name="dialectName" value="${opengamma.hts.db.dbdialect}"/>
  </bean>
  
  <bean id="cacheManager" class="org.springframework.cache.ehcache.EhCacheManagerFactoryBean">
    <property name="shared" value="true"/>
  </bean>

  <!-- ConfigMaster -->
  <bean id="sharedConfigMaster" class="com.opengamma.masterdb.config.DbConfigMaster">
    <constructor-arg ref="cfgDbConnector" />
    <property name="uniqueIdScheme" value="${opengamma.config.db.configmaster.scheme}" />
  </bean>

  <!-- Config loaders, should be commented out most of the time -->
  <!--bean id="curveLoader" class="com.opengamma.financial.analytics.ircurve.YieldCurveConfigPopulator">
    <constructor-arg ref="sharedConfigMaster" />
  </bean>
  <bean id="currencyMatrixLoader" class="com.opengamma.financial.currency.CurrencyMatrixConfigPopulator">
    <constructor-arg ref="sharedConfigMaster" />
  </bean>
  <bean id="swaptionSurfaceLoader" class="com.opengamma.financial.analytics.volatility.surface.SwaptionVolatilitySurfaceConfigPopulator">
    <constructor-arg ref="sharedConfigMaster" />
  </bean>
  <bean id="irFutureSurfaceLoader" class="com.opengamma.financial.analytics.volatility.surface.IRFutureOptionSurfaceConfigPopulator">
    <constructor-arg ref="sharedConfigMaster" />
  </bean>
  <bean id="fxVolatilitySurfaceLoader" class="com.opengamma.financial.analytics.volatility.surface.FXOptionVolatilitySurfaceConfigPopulator">
    <constructor-arg ref="sharedConfigMaster" />
  </bean>
  <bean id="equityOptionSurfaceLoader" class="com.opengamma.financial.analytics.volatility.surface.EquityOptionSurfaceConfigPopulator">
    <constructor-arg ref="sharedConfigMaster" />
  </bean>
  <bean id="cubeLoader" class="com.opengamma.financial.analytics.volatility.cube.VolatilityCubeConfigPopulator">
    <constructor-arg ref="sharedConfigMaster" />
  </bean-->
  
  <bean id="sharedConfigSource" class="com.opengamma.master.config.impl.MasterConfigSource">
    <constructor-arg ref="sharedConfigMaster" />
  </bean>
  
  <!-- ExchangeMaster -->
  <bean id="dbExchangeMaster" class="com.opengamma.masterdb.exchange.DbExchangeMaster">
    <constructor-arg ref="finDbConnector" />
    <property name="uniqueIdScheme" value="${opengamma.financial.db.exchangemaster.scheme}" />
  </bean>

  <bean id="sharedExchangeSource" class="com.opengamma.master.exchange.impl.MasterExchangeSource">
    <constructor-arg ref="dbExchangeMaster"/>
  </bean>
  
  <!-- HolidayMaster -->
  <bean id="dbHolidayMaster" class="com.opengamma.masterdb.holiday.DbHolidayMaster">
    <constructor-arg ref="finDbConnector" />
    <property name="uniqueIdScheme" value="${opengamma.financial.db.holidaymaster.scheme}" />
  </bean>
  <bean id="sharedHolidaySource" class="com.opengamma.master.holiday.impl.ConcurrentMapCachingMasterHolidaySource" destroy-method="stop" >
    <constructor-arg ref="dbHolidayMaster"/>
  </bean>

  <!-- SecurityMaster -->
  <bean id="securityMasterChangeManager" class="com.opengamma.core.change.BasicChangeManager" />
  <bean id="dbSecurityMaster" class="com.opengamma.masterdb.security.DbSecurityMaster">
    <constructor-arg ref="finDbConnector" />
    <property name="changeManager" ref="securityMasterChangeManager" />
    <property name="uniqueIdScheme" value="${opengamma.financial.db.securitymaster.scheme}" />
    <property name="detailProvider">
        <bean class="com.opengamma.masterdb.security.EHCachingSecurityMasterDetailProvider" >
                <constructor-arg>
                  <bean class="com.opengamma.masterdb.security.hibernate.HibernateSecurityMasterDetailProvider" />
                </constructor-arg>
                <constructor-arg ref="cacheManager" />
        </bean>
    </property>
  </bean>
  <bean id="sharedSecuritySource" class="com.opengamma.financial.security.EHCachingFinancialSecuritySource">
    <constructor-arg>
      <bean class="com.opengamma.financial.security.MasterFinancialSecuritySource">
        <constructor-arg ref="dbSecurityMaster" />
      </bean>
    </constructor-arg>
    <constructor-arg ref="cacheManager" />
  </bean>

  <!-- PortfolioMaster/PositionMaster -->
  <bean id="dbPortfolioMasterChangeManager" class="com.opengamma.core.change.JmsChangeManager" init-method="start" >
    <constructor-arg ref="jmsConnector" />
    <constructor-arg value="dbPortfolioMasterChangeManager" />
  </bean> 
  <bean id="dbPortfolioMaster" class="com.opengamma.masterdb.portfolio.DbPortfolioMaster">
    <constructor-arg ref="finDbConnector" />
    <property name="uniqueIdScheme" value="${opengamma.financial.db.portfoliomaster.scheme}" />
    <property name="changeManager" ref="dbPortfolioMasterChangeManager" />
  </bean>
  <bean id="dbPositionMaster" class="com.opengamma.masterdb.position.DbPositionMaster">
    <constructor-arg ref="finDbConnector" />
    <property name="uniqueIdScheme" value="${opengamma.financial.db.positionmaster.scheme}" />
  </bean>
  <bean id="sharedPositionSource" class="com.opengamma.core.position.impl.EHCachingPositionSource">
    <constructor-arg>
      <bean class="com.opengamma.master.position.impl.MasterPositionSource">
        <constructor-arg ref="dbPortfolioMaster" />
        <constructor-arg ref="dbPositionMaster" />
      </bean>
    </constructor-arg>
    <constructor-arg ref="cacheManager" />
  </bean>

  <!-- FunctionCostsMaster --> 
  <bean id="dbFunctionCostsMaster" class="com.opengamma.masterdb.engine.stats.DbFunctionCostsMaster">
    <constructor-arg ref="finDbConnector" />
  </bean>

  <!-- TimeSeries database -->
  <bean id="dbHtsMaster" class="com.opengamma.masterdb.historicaltimeseries.DbHistoricalTimeSeriesMaster">
    <constructor-arg ref="htsDbConnector"/>
    <property name="uniqueIdScheme" value="${opengamma.financial.db.htsmaster.scheme}" />
  </bean>
  <bean id="sharedHistoricalTimeSeriesSource" class="com.opengamma.core.historicaltimeseries.impl.EHCachingHistoricalTimeSeriesSource">
    <constructor-arg>
      <bean class="com.opengamma.master.historicaltimeseries.impl.MasterHistoricalTimeSeriesSource">
        <constructor-arg ref="dbHtsMaster"/>
        <constructor-arg>
          <bean class="com.opengamma.master.historicaltimeseries.impl.DefaultHistoricalTimeSeriesResolver">
          	<constructor-arg ref="dbHtsMaster"/>
          	<constructor-arg ref="sharedConfigSource"/>
          </bean>
        </constructor-arg>
      </bean>
    </constructor-arg>
    <constructor-arg ref="cacheManager" />
  </bean>

  <!-- Curves -->
  <bean id="sharedInterpolatedYieldCurveDefinitionSource" class="com.opengamma.financial.analytics.ircurve.EHCachingInterpolatedYieldCurveDefinitionSource">
        <constructor-arg ref="configDBInterpolatedYieldCurveDefinitionSource" />
        <constructor-arg ref="cacheManager" />
  </bean>
  <bean id="configDBInterpolatedYieldCurveDefinitionSource" class="com.opengamma.financial.analytics.ircurve.ConfigDBInterpolatedYieldCurveDefinitionSource">
    <constructor-arg ref="sharedConfigSource" />
  </bean>
  <bean id="sharedInterpolatedYieldCurveSpecificationBuilder" class="com.opengamma.financial.analytics.ircurve.ConfigDBInterpolatedYieldCurveSpecificationBuilder">
    <constructor-arg ref="sharedConfigSource" />
  </bean>
  
  <!-- Vol Cubes-->
  <!-- TODO: this properly, user source and cacheing -->
  <bean id="combinedVolatilityCubeDefinitionSource" class="com.opengamma.financial.analytics.volatility.cube.ConfigDBVolatilityCubeDefinitionSource">
    <constructor-arg ref="sharedConfigSource" />
  </bean>
  
  <!-- Currency conversion -->
  <bean id="sharedCurrencyMatrixSource" class="com.opengamma.financial.currency.ConfigDBCurrencyMatrixSource">
    <constructor-arg ref="sharedConfigSource" />
  </bean>
  
  <!-- Batch -->
  <bean id="batchDataSource" class="org.apache.commons.dbcp.BasicDataSource" destroy-method="close">
    <property name="driverClassName" value="${opengamma.overnight-batch.jdbc.driver}" />
    <property name="url" value="${opengamma.overnight-batch.jdbc.url}" />
    <property name="username" value="${opengamma.overnight-batch.jdbc.username}" />
    <property name="password" value="${opengamma.overnight-batch.jdbc.password}" />
  </bean>
  <bean id="batchDbConnector" parent="abstractDbConnector">
    <property name="name" value="Batch"/>
    <property name="dataSource" ref="batchDataSource"/>
    <property name="dialectName" value="${opengamma.overnight-batch.db.dbdialect}"/>
    <property name="allowHibernateThreadBoundSession" value="true"/>
    <property name="hibernateMappingFiles">
      <list>
        <bean class="com.opengamma.masterdb.batch.HibernateBatchDbFiles"/>
      </list> 
    </property>
  </bean>
  <bean id="dbBatchMaster" class="com.opengamma.masterdb.batch.DbBatchMaster">
    <constructor-arg ref="batchDbConnector"/>  	
  </bean>

  <!-- Function configuration -->
  <bean id="demoFunctionRepositoryConfiguration" class="com.opengamma.engine.function.config.CombiningRepositoryConfigurationSource">
    <constructor-arg>
      <list>
        <bean class="com.opengamma.web.spring.DemoStandardFunctionConfiguration" />
        <bean class="com.opengamma.web.spring.DemoCurveFunctionConfiguration">
          <property name="configMaster" ref="sharedConfigMaster" />
          <property name="conventionBundleSource" ref="conventionBundleSource" />
        </bean>
        <bean class="com.opengamma.web.spring.DemoSurfaceFunctionConfiguration">
          <property name="configMaster" ref="sharedConfigMaster" />
        </bean>
       </list>
    </constructor-arg>
  </bean>
  
  <!-- MarketDataSnapshotMaster -->
  <bean id="dbSnapshotMasterChangeManager" class="com.opengamma.core.change.JmsChangeManager" init-method="start" >
    <constructor-arg ref="jmsConnector" />
    <constructor-arg value="dbSnapshotMasterChangeManager" />
  </bean>
  <bean id="dbSnapshotMaster" class="com.opengamma.masterdb.marketdatasnapshot.DbMarketDataSnapshotMaster">
    <constructor-arg ref="finDbConnector" />
    <property name="changeManager" ref="dbSnapshotMasterChangeManager" />
    <property name="uniqueIdScheme" value="${opengamma.financial.db.snapshotmaster.scheme}" />
  </bean>
  
  <!-- TODO EHCachingFinancialSnapshotSource -->
  <bean id="sharedSnapshotSource" class="com.opengamma.core.marketdatasnapshot.impl.DelegatingSnapshotSource">
  	<constructor-arg>
      <bean class="com.opengamma.master.marketdatasnapshot.impl.MasterSnapshotSource">
        <constructor-arg ref="dbSnapshotMaster" />
      </bean>
    </constructor-arg>
  </bean>
</beans>
